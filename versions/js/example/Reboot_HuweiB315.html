<!DOCTYPE html>
<html>
<head>
<title>Reboot HuweiB315</title>
</head>
<body>

<h1>Reboot HuweiB315 Script</h1>
<p>Enters credentials and reboots router</p>
<script src="aes.js"></script>
<script src="hmac-sha256.js"></script>
<script src="jquery-1.7.2.min.js"></script>
<script src="pbkdf2.js"></script>
<script src="scram.js"></script>
<script>
  function login(destnation, callback, redirectDes) {
    var name = "admin";
    var psd = "adminadmin";
    var g_scarm_login = true;
    if (true == g_scarm_login) {
        var scram = CryptoJS.SCRAM();
        var firstNonce = scram.nonce().toString();
        var firstPostData = {
            username: name,
            firstnonce: firstNonce,
            mode: RSA_LOGIN_MODE
        };
        var firstXml = object2xml('request', firstPostData);
        saveAjaxData('api/user/challenge_login', firstXml, function($xml) {
            var ret = xml2object($xml);
            if (ret.type == 'response') {
                g_scarm_salt = CryptoJS.enc.Hex.parse(ret.response.salt);
                var iter = ret.response.iterations;
                var finalNonce = ret.response.servernonce;
                var authMsg = firstNonce + "," + finalNonce + "," + finalNonce;
                var saltPassword = scram.saltedPassword(psd, g_scarm_salt, iter);
                saltPassword = saltPassword.toString();
                var clientKey = scram.clientKey(CryptoJS.enc.Hex.parse(saltPassword));
                clientKey = clientKey.toString();
                var serverKey = scram.serverKey(CryptoJS.enc.Hex.parse(saltPassword));
                serverKey = serverKey.toString();
                var clientProof = scram.clientProof(psd, g_scarm_salt, iter, authMsg);
                clientProof = clientProof.toString();
                var finalPostData = {
                    clientproof: clientProof,
                    finalnonce: finalNonce
                };
                var finalXml = object2xml('request', finalPostData);
                saveAjaxData('api/user/authentication_login', finalXml, function($xml) {
                    ret = xml2object($xml);
                    if (ret.type == 'response') {
                        var serverProof = scram.serverProof(psd, g_scarm_salt, iter, authMsg);
                        serverProof = serverProof.toString();
                        if (ret.response.serversignature == serverProof) {
                            var publicKey = ret.response.rsan;
                            var publicKeySignature = scram.signature(CryptoJS.enc.Hex.parse(publicKey), CryptoJS.enc.Hex.parse(serverKey));
                            publicKeySignature = publicKeySignature.toString();
                            if (ret.response.rsapubkeysignature == publicKeySignature) {
                                g_encPublickey.e = ret.response.rsae;
                                g_encPublickey.n = ret.response.rsan;
                                storagePubkey(g_encPublickey.n, g_encPublickey.e);
                                getAjaxData('api/user/state-login', function($xml) {
                                    restartHeartBeatTimer();
                                    var ret = xml2object($xml);
                                    if (ret.type == 'response') {
                                        if ('undefined' != typeof(ret.response.firstlogin)) {
                                            g_default_password_status = parseInt(ret.response.firstlogin, 10);
                                        }
                                        g_login_state = ret.response.State;
                                    }
                                });
                            } else {
                                console.log("IDS_login_fialed_prompt");
                            }
                        } else {
                            console.log("IDS_login_fialed_prompt");
                        }
                    } else {
                        if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_ORERRUN) {
                            console.log("IDS_login_username_password_input_overrun");
                        } else if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_WRONG) {
                            console.log("IDS_login_username_password_wrong");
                        }
                    }
                });
            } else {
                if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_ORERRUN) {
                    console.log("IDS_login_username_password_input_overrun");
                } else if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_WRONG) {
                    console.log("IDS_login_username_password_wrong");
                } else if (ret.error.code == ERROR_LOGIN_ALREADY_LOGIN) {
                    console.log("common_user_login_repeat");
                }
            }
        });
    } else {
        if ($.isArray(g_requestVerificationToken)) {
            if (g_requestVerificationToken.length > 0) {
                if (g_password_type == '4') {
                    psd = base64encode(SHA256(name + base64encode(SHA256(psd)) + g_requestVerificationToken[0]));
                } else {
                    psd = base64encode(psd);
                }
            } else {
                setTimeout(function() {
                    if (g_requestVerificationToken.length > 0) {
                        login(destnation, callback, redirectDes);
                    }
                }, 50)
                restartHeartBeatTimer();
                return;
            }
        } else {
            psd = base64encode(psd);
        }
        var request = {
            Username: name,
            Password: psd,
            password_type: g_password_type
        };
        if (valid) {
            var xmlstr = object2xml('request', request);
            saveAjaxData('api/user/login', xmlstr, function($xml) {
                //log.debug('api/user/login successed!');
                console.log("api/user/login successed!");
                restartHeartBeatTimer();
                var ret = xml2object($xml);
                if (isAjaxReturnOK(ret)) {
                  console.log("Hello isAjaxReturnOK");
                } else {
                    if (ret.type == 'error') {
                        if (ret.error.code == ERROR_LOGIN_PASSWORD_WRONG) {
                          console.log("system_hint_wrong_password");
                        } else if (ret.error.code == ERROR_LOGIN_ALREADY_LOGIN) {
                          console.log("common_user_login_repeat");
                        } else if (ret.error.code == ERROR_LOGIN_USERNAME_WRONG) {
                          console.log("settings_hint_user_name_not_exist");
                        } else if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_WRONG) {
                          console.log("IDS_login_username_password_wrong");
                        } else if (ret.error.code == ERROR_LOGIN_USERNAME_PWD_ORERRUN) {
                          console.log("IDS_login_username_password_input_overrun");
                        }
                    }
                }
            }, {
                enc: true
            });
        }
    }
}
</script>
</body>
</html>