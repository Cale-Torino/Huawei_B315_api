<!DOCTYPE html>
<html>
<head>
<title>Reboot HuweiB315</title>
<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
</head>
<body>

<h1>Reboot HuweiB315 Script</h1>
<p>Enters credentials and reboots router: http://127.0.0.1/b315/index2.html</p>
<button id="btn" type="button" name="button">Login</button>
<button id="btn2" type="button" name="button">Get Devices</button>

<script type="text/javascript" src="aes.js"></script>
<script type="text/javascript" src="hmac-sha256.js"></script>
<script type="text/javascript" src="pbkdf2.js"></script>
<script type="text/javascript" src="scram.js"></script>
<script>
$(document).ready(function(){
$("#btn").click(function(){
    var name = "admin";
    var psd = "adminadmin";
    var g_scarm_login = false;
    var RSA_LOGIN_MODE = '1';
    var scram = CryptoJS.SCRAM();
        var firstNonce = scram.nonce().toString();
        var xml = '<?xml version="1.0" encoding="UTF-8"?><request><username>'+name+'</username><firstnonce>'+firstNonce+'</firstnonce><mode>'+RSA_LOGIN_MODE+'</mode></request>';
        //var xml = '<?xml version="1.0" encoding="UTF-8"?><request><clientproof>d49e7178b4fbce8f2c4229066cdb318b3439f9bfb5413fbd4d5d99a11297c3ab</clientproof><finalnonce>8b5a33a6023c7e8876a4a3ffba100f9d9c120ca1ad53b9166e6dfabeb7b228e9NA7h7hHL4FvGsq7g51ywV8vp1EJY3LyP</finalnonce></request>';

//var data = JSON.stringify(json);

function base64_encode(s) {      
    return btoa(unescape(encodeURIComponent(s)));
}

// function to handle success
function success() {
  //var data = JSON.parse(this.responseText); //parse the string to JSON
  //console.log('Success:', data);
  alert('Success: ' + this.responseText);
  console.log(this.responseText);
  //$("#json").html(JSON.stringify(this.responseText));
}

// function to handle success
function challengeloginSuccess(cookie,response,tokinfo) {
  var parser = new DOMParser();
  var xmlDoc = parser.parseFromString(response,"application/xml");
  console.log("response: " + response); //Correctly prints JSON content to console
  var values = [];
  for (let nod of xmlDoc.querySelector('response').children)
  {
    values.push(nod.textContent);
  }
  console.log(values[0]);
  console.log(values[1]);
  console.log(values[2]);
   g_scarm_salt = CryptoJS.enc.Hex.parse(values[0]);
   var iter = values[1];
   var finalNonce = values[2];
   var authMsg = firstNonce + "," + finalNonce + "," + finalNonce;
   var saltPassword = scram.saltedPassword(psd, g_scarm_salt, iter);
   saltPassword = saltPassword.toString();
   var clientKey = scram.clientKey(CryptoJS.enc.Hex.parse(saltPassword));
   clientKey = clientKey.toString();
   var serverKey = scram.serverKey(CryptoJS.enc.Hex.parse(saltPassword));
   serverKey = serverKey.toString();
   var clientProof = scram.clientProof(psd, g_scarm_salt, iter, authMsg);
   clientProof = clientProof.toString();
   var x = '<?xml version="1.0" encoding="UTF-8"?><request><clientproof>'+clientProof+'</clientproof><finalnonce>'+finalNonce+'</finalnonce></request>';
   //console.log('clientProof='+clientProof);
   //console.log('finalNonce='+finalNonce);
   //SesTokInfo();
   authenticationlogin(cookie,x,tokinfo);
}

// function to handle success
function SesTokInfoSuccess(response) {
  var parser = new DOMParser();
  var xmlDoc = parser.parseFromString(response,"application/xml");
  //console.log(xmlDoc.getElementsByTagName('response')[0]);
  var values = [];
  for (let nod of xmlDoc.querySelector('response').children)
  {
    //values[nod.nodeName];
    values.push(nod.textContent);
    //console.log( 'nodeName =', nod.nodeName);
    //console.log( 'value =', nod.textContent);
  // for(let attr of nod.attributes)
  //   {
  //     console.log('---> attribute: name=', attr.name, ',  value=', attr.value);
  //   }
  // for(let subChild of nod.children)
  //   {
  //     console.log( '---subChild name:', subChild.nodeName);
  //     console.log( '----------content ->', subChild.textContent);
  //   }
  }
  //console.log( 'sesinfo =', values[0]);
  //console.log( 'tokinfo =', values[1]);
  //statelogin(base64_encode(values[0]));
  challengelogin(base64_encode(values[0]),xml,base64_encode(values[1]));
  //authenticationlogin(base64_encode(values[0]),xml,base64_encode(values[1]))
  
}

// function to handle success
function authenticationloginSuccess(response) {
  alert('Success: ' + response);
  console.log(response);
}

// function to handle error
function error(err) {
  console.log('Request Failed', err); //error details will be in the "err" object
  alert('Failed: ' + JSON.stringify(err));
}

function SesTokInfo(){
  var xhr = new XMLHttpRequest(); //invoke a new instance of the XMLHttpRequest
  xhr.onerror = error;  // call error function if request failed
  xhr.open('GET', 'http://127.0.0.1/b315/curl.php?data=GET&url=http://192.168.8.1/api/webserver/SesTokInfo', true); // open a GET request
  xhr.onreadystatechange = function () {
        if (xhr.readyState == XMLHttpRequest.DONE) {
        var response = xhr.responseText;
        SesTokInfoSuccess(response);
        }
    }
  xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');//application/json;charset=UTF-8
  xhr.send(null); // send the request to the server.
}

function statelogin(cookie){
  var xhr = new XMLHttpRequest(); //invoke a new instance of the XMLHttpRequest
  xhr.onload = success; // call success function if request is successful
  xhr.onerror = error;  // call error function if request failed
  xhr.open('GET', 'http://127.0.0.1/b315/curl.php?data=GET&url=http://192.168.8.1/api/user/state-login&cookie='+cookie, true); // open a GET request
  xhr.send(); // send the request to the server.
}

function challengelogin(cookie,xml,tokinfo){
  //console.log('cookie='+cookie+'\n xml='+xml+'\n tokinfo='+tokinfo);
  var xhr = new XMLHttpRequest(); //invoke a new instance of the XMLHttpRequest
  xhr.onerror = error;  // call error function if request failed
  xhr.open('POST', 'http://127.0.0.1/b315/curl.php?data=POST&url=http://192.168.8.1/api/user/challenge_login&cookie='+cookie+'&postdata='+xml+'&tokinfo='+tokinfo, true); // open a GET request
  xhr.onreadystatechange = function () {
        if (xhr.readyState == XMLHttpRequest.DONE) {
        var response = xhr.responseText;
        challengeloginSuccess(cookie,response,tokinfo);
        }
    }
  xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');//application/json;charset=UTF-8
  xhr.send(null); // send the request to the server.
}

function authenticationlogin(cookie,xml,tokinfo){
  var xhr = new XMLHttpRequest(); //invoke a new instance of the XMLHttpRequest
  xhr.onerror = error;  // call error function if request failed
  xhr.open('POST', 'http://127.0.0.1/b315/curl.php?data=POST&url=http://192.168.8.1/api/user/authentication_login&cookie='+cookie+'&postdata='+xml+'&tokinfo='+tokinfo, true); // open a GET request
  xhr.onreadystatechange = function () {
        if (xhr.readyState == XMLHttpRequest.DONE) {
        var response = xhr.responseText;
        authenticationloginSuccess(response);
        }
    }
  xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');//application/json;charset=UTF-8
  xhr.send(null); // send the request to the server.
}

SesTokInfo();

});

$("#btn2").click(function(){
var timestamp = getTime();
var appid = "YzfeftUVcZ6twZw1OoVKPRFYTrGEg01Q";
var apikey = "5e17876c-48ae-41d2-b4f6-6057decc85c7";
var at = "0fa1a296dc460432a39b2f4d0e05cf07221b712c";
var token = "Bearer "+ at;

function getTime(){
    var timestamp = new Date().getTime();
    return timestamp;
}

// function to handle success
function success() {
  //var data = JSON.parse(this.responseText); //parse the string to JSON
  //console.log('Success:', data);
  alert('Success: ' + JSON.stringify(this.responseText));
  console.log(this.responseText);
  $("#json").html(JSON.stringify(this.responseText));
}

// function to handle error
function error(err) {
  console.log('Request Failed', err); //error details will be in the "err" object
  alert('Failed: ' + JSON.stringify(err));
}

function testFunction(token,appid){
  console.log(token);
  var xhr = new XMLHttpRequest(); //invoke a new instance of the XMLHttpRequest
  xhr.onload = success; // call success function if request is successful
  xhr.onerror = error;  // call error function if request failed

  xhr.open('GET', 'https://eu-api.coolkit.cc:8080/api/user/device?lang=en&appid='+appid+'&ts='+timestamp+'&version=8&getTags=1', true); // open a GET request
  xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');//application/json;charset=UTF-8
  xhr.setRequestHeader('Authorization', token);//application/json;charset=UTF-8
  xhr.send(); // send the request to the server.
}

testFunction(token,appid);

});


console.log("Ready");
});

</script>
</body>
</html>